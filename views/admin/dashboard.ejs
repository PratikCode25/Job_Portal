<!DOCTYPE html>
<html lang="en">
  <%-include('./layouts/head') %>

  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <%-include('./layouts/sidebar') %>
      <!-- End of Sidebar -->

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
          <!-- Topbar -->
          <%-include('./layouts/topbar') %>
          <!-- End of Topbar -->

          <!-- Begin Page Content -->
          <div class="container-fluid">
            <!-- Page Heading -->
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
              <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
            </div>

            <div class="row text-white">
              <div class="col-md-2">
                <div class="card bg-primary admin-card">
                  <div class="card-body">
                    <div class="admin-card-title">Total Candidates</div>
                    <div class="admin-card-value" id="totalCandidates"><%=totalCandidates%></div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card bg-warning admin-card">
                  <div class="card-body">
                    <div class="admin-card-title">Total Companies</div>
                    <div class="admin-card-value" id="totalCompanies"><%=totalCompanies%></div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card bg-info admin-card">
                  <div class="card-body">
                    <div class="admin-card-title">Total Recruiters</div>
                    <div class="admin-card-value" id="totalRecruiters"><%=totalRecruiters%></div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card bg-success admin-card">
                  <div class="card-body">
                    <div class="admin-card-title">Total Jobs Posted</div>
                    <div class="admin-card-value" id="totalJobs"><%=totalJobsPosted%></div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card bg-secondary admin-card">
                  <div class="card-body">
                    <div class="admin-card-title">Active Jobs</div>
                    <div class="admin-card-value" id="jobsActive"><%=totalActiveJobs%></div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card bg-danger admin-card">
                  <div class="card-body">
                    <div class="admin-card-title">Total Applications</div>
                    <div class="admin-card-value" id="applicationsTotal"><%=totalApplications%></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Second Row -->
            <div class="row text-white">
              <div class="col-md-2">
                <div class="card bg-success admin-card">
                  <div class="card-body">
                    <div class="admin-card-title">Accepted Applications</div>
                    <div class="admin-card-value" id="applicationsAccepted"><%=totalAcceptedApplications%></div>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <div class="card bg-danger admin-card">
                  <div class="card-body">
                    <div class="admin-card-title">Rejected Applications</div>
                    <div class="admin-card-value" id="applicationsRejected"><%=totalRejectedApplications%></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts Section -->
            <div class="row">
              <div class="col-md-6">
                <div class="card admin-card">
                  <div id="jobs-data" data-chart='<%- JSON.stringify(chartData.jobsOverTime) %>'></div>
                  <div class="card-body">
                    <h5 class="card-title">Jobs Posted Over Time</h5>
                    <div class="admin-chart-box">
                      <canvas id="jobsPostedChart" class="admin-chart-container"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card admin-card">
                  <div id="applications-data" data-chart='<%- JSON.stringify(chartData.applicationsOverTime) %>'></div>
                  <div class="card-body">
                    <h5 class="card-title">Applications Over Time</h5>
                    <div class="admin-chart-box">
                      <canvas id="applicationsChart" class="admin-chart-container"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              </div>

               <div class="row">
              <div class="col-md-6">
                <div class="card admin-card">
                    <div id="top-industries-data" data-chart='<%- JSON.stringify(chartData.topIndustriesJobPosting) %>'></div>
                  <div class="card-body">
                    <h5 class="card-title">Top 5 Industries Posting Jobs</h5>
                    <div class="admin-chart-box">
                      <canvas id="topIndustriesChart" class="admin-chart-container"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card admin-card">
                   <div id="top-jobCategories-data" data-chart='<%- JSON.stringify(chartData.topJobCategoriesJobPosting) %>'></div>
                  <div class="card-body">
                    <h5 class="card-title">Top 5 Job Categories Posting Jobs</h5>
                    <div class="admin-chart-box">
                      <canvas id="topJobCategoriesChart" class="admin-chart-container"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card admin-card">
                     <div id="top-workExpStatus-data" data-chart='<%- JSON.stringify(chartData.candidateWorkExperienceStatus) %>'></div>
                  <div class="card-body">
                    <h5 class="card-title">Candidate Work Status Split</h5>
                    <div class="admin-chart-box" style="overflow: hidden; padding: 10px;">
                      <canvas id="workStatusChart" class="admin-chart-container" style="width: 100%; height: auto; max-height: 350px;"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card admin-card">
                  <div class="card-body">
                    <h5 class="card-title">Top 5 Most Applied Jobs</h5>
                    <div class="admin-chart-box">
                    <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Job Title</th>
        <th>Company</th>
        <th>Applications</th>
        <th>Job Type</th>
        <th>Posted At</th>
      </tr>
    </thead>
    <tbody>
      <% if (topAppliedJobs && topAppliedJobs.length > 0) { %>
        <% topAppliedJobs.forEach(job => { %>
          <tr>
            <td><%= job.jobTitle %></td>
            <td><%= job.companyName %></td>
            <td><%= job.applicationCount %></td>
            <td><%= job.jobType.charAt(0).toUpperCase() + job.jobType.slice(1) %></td>
            <td><%= new Date(job.postedAt).toLocaleDateString("en-IN", {
                                                          day: "2-digit",
                                                          month: "2-digit",
                                                          year: "numeric",
                                                        }) %></td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="5" class="text-center">No data available</td>
        </tr>
      <% } %>
    </tbody>
  </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <%-include('./layouts/footer') %>
        <!-- End of Footer -->
      </div>
      <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <%-include('./layouts/footer-scripts') %>
    <script>
      $(document).ready(function () {
        const jobsDataRaw = $("#jobs-data").data("chart");
        const jobsData = typeof jobsDataRaw === "string" ? JSON.parse(jobsDataRaw) : jobsDataRaw;

        const ctxJobsOverTime = $("#jobsPostedChart")[0].getContext("2d");

        new Chart(ctxJobsOverTime, {
          type: "bar",
          data: {
            labels: jobsData.labels,
            datasets: [
              {
                label: "Jobs Posted",
                data: jobsData.data,
                backgroundColor: "#007bff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });

        const applicationsDataRaw = $("#applications-data").data("chart");
        const applicationsData = typeof applicationsDataRaw === "string" ? JSON.parse(applicationsDataRaw) : applicationsDataRaw;

        const ctxApplicationsOverTime = $("#applicationsChart")[0].getContext("2d");

        new Chart(ctxApplicationsOverTime, {
          type: "line",
          data: {
            labels: applicationsData.labels,
            datasets: [
              {
                label: "Applications",
                data: applicationsData.data,
                borderColor: "#28a745",
                backgroundColor: "rgba(40, 167, 69, 0.1)",
                tension: 0.3,
                fill: true,
                pointBackgroundColor: "#28a745",
                pointRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
            plugins: {
              legend: {
                display: true,
                labels: {
                  color: "#333",
                },
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
          },
        });

    const industriesRaw = $('#top-industries-data').data('chart');
    const industriesData = typeof industriesRaw === 'string' ? JSON.parse(industriesRaw) : industriesRaw;

    const ctxTopIndustriesJobPosting = $('#topIndustriesChart')[0].getContext('2d');

   

    new Chart(ctxTopIndustriesJobPosting, {
      type: 'bar',
      data: {
        labels: industriesData.labels,
        datasets: [{
          label: 'Jobs Posted',
          data: industriesData.data,
          backgroundColor: '#17a2b8'
        }]
      },
      options: {
        indexAxis: 'y', 
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: true
          }
        }
      }
    });


    const jobCategoriesRaw = $('#top-jobCategories-data').data('chart');
    const jobCategoriesData = typeof jobCategoriesRaw === 'string' ? JSON.parse(jobCategoriesRaw) : jobCategoriesRaw;

    const ctxTopjobCategoriesJobPosting = $('#topJobCategoriesChart')[0].getContext('2d');

   

    new Chart(ctxTopjobCategoriesJobPosting, {
      type: 'bar',
      data: {
        labels: jobCategoriesData.labels,
        datasets: [{
          label: 'Jobs Posted',
          data: jobCategoriesData.data,
          backgroundColor: '#28a745'
        }]
      },
      options: {
        indexAxis: 'y', 
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: true
          }
        }
      }
    });

    const workExpStatusRaw = $('#top-workExpStatus-data').data('chart');
    const workExpStatusData = typeof workExpStatusRaw === 'string' ? JSON.parse(workExpStatusRaw) : workExpStatusRaw;

    const ctxWorkExperienceSplit = $('#workStatusChart')[0].getContext('2d');
    
     new Chart(ctxWorkExperienceSplit, {
      type: 'pie',
      data: {
        labels: workExpStatusData.labels,
        datasets: [{
          label: 'Candidate Work Status',
          data: workExpStatusData.data,
          backgroundColor: workExpStatusData.labels.map(label => {
            switch (label.toLowerCase()) {
              case 'fresher': return '#007bff';      
              case 'experienced': return '#28a745';  
              default: return '#6c757d';          
            }
          }),
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            enabled: true
          }
        }
      }
    });

      });
    </script>
  </body>
</html>
